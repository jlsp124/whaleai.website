<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Whale AI ‚Äì Connect Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 16px;
      display: flex;
      justify-content: center;
    }
    .card {
      max-width: 480px;
      width: 100%;
      background: #020617;
      border-radius: 16px;
      padding: 20px 18px 24px;
      box-shadow: 0 0 0 1px rgba(148,163,184,0.15);
    }
    h1 {
      font-size: 22px;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      background: #22c55e;
      color: #020617;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    button.secondary {
      background: transparent;
      color: #9ca3af;
      border: 1px solid rgba(148,163,184,0.4);
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .step {
      border-radius: 12px;
      padding: 12px 12px 10px;
      margin-bottom: 10px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.25);
    }
    .step-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.4);
      background: #020617;
      color: #e5e7eb;
      padding: 8px 10px;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: rgba(15,23,42,0.9);
      border-radius: 6px;
      padding: 6px 8px;
      word-break: break-all;
      margin: 4px 0 8px;
    }
    .status {
      font-size: 12px;
      margin-top: 10px;
      color: #9ca3af;
    }
    .status.success {
      color: #4ade80;
    }
    .status.error {
      color: #f97373;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(37,99,235,0.15);
      color: #93c5fd;
      font-size: 11px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="badge">
      <span>üêã Whale AI</span>
      <span>Non-custodial</span>
    </div>
    <h1>Connect your wallet</h1>
    <div class="subtitle">
      Approve a max SOL amount that Whale AI can use for copy-trading. You stay in full control and can revoke access anytime in Phantom.
    </div>

    <div id="step-1" class="step">
      <div class="step-title">1. Connect Phantom</div>
      <div class="label">Wallet</div>
      <div id="wallet-address" class="code">Not connected</div>
      <button id="connect-btn" onclick="connectPhantom()">
        <span>Connect Phantom</span>
      </button>
    </div>

    <div id="step-2" class="step" style="display:none;">
      <div class="step-title">2. Set trading cap</div>
      <div class="label">Max SOL Whale AI can use</div>
      <input id="max-sol" type="number" step="0.01" min="0" placeholder="e.g. 0.5" />
      <div class="label">This is a software cap inside Whale AI. You can always revoke delegation in Phantom itself.</div>
      <button id="save-btn" onclick="saveAndFinish()">
        <span>Save &amp; link wallet</span>
      </button>
      <button class="secondary" type="button" onclick="window.open('https://phantom.app/', '_blank')">
        Get Phantom
      </button>
    </div>

    <div id="status" class="status">
      Waiting for Phantom...
    </div>
  </div>

  <script>
    // For local testing:
    //   const BACKEND_URL = "http://localhost:8001";
    // For internet testing via ngrok, change this to your ngrok URL, e.g.
    //   const BACKEND_URL = "https://your-ngrok-subdomain.ngrok-free.app";
    const BACKEND_URL = "http://localhost:8001";

    let tgId = null;
    let walletAddress = null;

    function getTgIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("tg_id");
    }

    function setStatus(text, type) {
      const el = document.getElementById("status");
      el.textContent = text;
      el.className = "status" + (type ? " " + type : "");
    }

    async function connectPhantom() {
      try {
        if (!window.solana || !window.solana.isPhantom) {
          setStatus("Phantom wallet not detected. Open this page in a Phantom-enabled browser.", "error");
          alert("Phantom wallet not detected. Install Phantom or open in the Phantom in-app browser.");
          return;
        }
        const resp = await window.solana.connect({ onlyIfTrusted: false });
        walletAddress = resp.publicKey.toString();
        document.getElementById("wallet-address").textContent = walletAddress;
        document.getElementById("step-2").style.display = "block";
        setStatus("Wallet connected. Set a max SOL cap, then save.", "success");
      } catch (e) {
        console.error(e);
        setStatus("Failed to connect Phantom: " + (e.message || e), "error");
      }
    }

    async function saveAndFinish() {
      if (!walletAddress) {
        alert("Connect Phantom first.");
        return;
      }
      const maxSolStr = document.getElementById("max-sol").value;
      const maxSol = parseFloat(maxSolStr);
      if (isNaN(maxSol) || maxSol <= 0) {
        alert("Enter a positive max SOL amount.");
        return;
      }
      if (!tgId) {
        setStatus("Missing tg_id in URL. Open this from the Telegram bot's /linkwallet button.", "error");
        return;
      }

      setStatus("Saving wallet to Whale AI...", null);
      const payload = {
        tg_id: String(tgId),
        wallet_address: walletAddress,
        max_delegation_sol: maxSol
      };

      try {
        const res = await fetch(BACKEND_URL + "/api/wallet/connected", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const text = await res.text();
          console.error("Backend error:", text);
          setStatus("Backend error: " + text, "error");
          alert("Backend error: " + text);
          return;
        }
        setStatus("‚úÖ Wallet linked. You can go back to the Whale AI Telegram bot.", "success");
      } catch (e) {
        console.error(e);
        setStatus("Network error: " + (e.message || e), "error");
      }
    }

    window.addEventListener("load", () => {
      tgId = getTgIdFromUrl();
      if (!tgId) {
        setStatus("Missing tg_id in URL. Open this from the Telegram bot.", "error");
      } else {
        setStatus("Telegram ID: " + tgId + ". Connect Phantom to continue.", null);
      }
    });
  </script>
</body>
</html>
