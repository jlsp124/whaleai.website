<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Whale AI - Redeem Promo</title>
  <meta name="theme-color" content="#070b12" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .mini { min-height: 70vh; display: grid; place-items: center; padding: 72px 0; }
    .field { display: flex; flex-direction: column; gap: 8px; margin: 12px 0; }
    .status { margin-top: 12px; color: var(--muted); }
    .status.ok { color: #7cffb2; }
    .status.err { color: #ff9b9b; }
  </style>
</head>
<body>
  <header class="nav" data-nav>
    <div class="container nav-inner">
      <a class="brand" href="index.html">
        <img src="assets/whaleaifulllogo.png" alt="Whale AI" class="brand-logo" />
        <span class="sr-only">Whale AI</span>
      </a>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="waitlist.html">Waitlist</a>
      </nav>
      <button class="nav-toggle" data-nav-toggle>Menu</button>
    </div>
  </header>

  <main class="mini">
    <div class="container">
      <section class="card">
        <div class="eyebrow">Credits</div>
        <h2 style="margin:8px 0 6px;">Redeem promo code</h2>
        <p class="muted" style="margin:0;">Paste your code and redeem it instantly.</p>

        <div class="field">
          <label class="eyebrow" for="code">Promo code</label>
          <input id="code" class="input" placeholder="e.g. FIRST100" autocomplete="off" />
        </div>

        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button id="redeemBtn" class="btn primary">Redeem</button>
          <a id="openBot" class="btn ghost" href="#" target="_blank" rel="noopener">Open bot</a>
        </div>

        <div id="status" class="status">Waiting.</div>
      </section>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(window.location.search);
    const tgId = qs.get("tg_id");
    const apiBase = (qs.get("api") || window.location.origin).replace(/\/$/, "");

    const statusEl = document.getElementById("status");
    const redeemBtn = document.getElementById("redeemBtn");
    const codeEl = document.getElementById("code");

    function setStatus(text, kind) {
      statusEl.textContent = text;
      statusEl.className = "status" + (kind ? " " + kind : "");
    }

    document.getElementById("openBot").href = "https://t.me/WhaleAiTrading_bot";

    async function redeem() {
      const code = (codeEl.value || "").trim();
      if (!tgId) return setStatus("Missing tg_id. Open this from the Telegram bot.", "err");
      if (!code) return setStatus("Enter a promo code.", "err");

      redeemBtn.disabled = true;
      setStatus("Redeeming.", "");
      try {
        const res = await fetch(apiBase + "/api/promo/redeem", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tg_id: String(tgId), code }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || "Request failed");
        if (data.ok) {
          setStatus(`Promo applied! +${data.credits_added} credits`, "ok");
        } else {
          setStatus("Invalid or already used promo code.", "err");
        }
      } catch (e) {
        setStatus("" + (e.message || e), "err");
      } finally {
        redeemBtn.disabled = false;
      }
    }

    redeemBtn.addEventListener("click", redeem);
    codeEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") redeem();
    });

    if (!tgId) {
      setStatus("Missing tg_id. Open this from the Telegram bot.", "err");
    } else {
      setStatus("Ready. Enter a promo code.", "");
    }
  </script>
  <script src="script.js" defer></script>
</body>
</html>
