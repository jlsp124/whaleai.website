<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Whale AI - Settings</title>
  <meta name="theme-color" content="#070b12" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    .page { padding: 28px 0 70px; }
    .muted2 { color: var(--muted); font-size: 13px; line-height: 1.5; }
    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
    .grid2 { display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 900px){ .grid2{grid-template-columns: 1fr;} }
    .panel { padding: 18px; }
    .panel h3 { margin: 0 0 8px; }
    .input {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--edge);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
    }
    .input:focus { box-shadow: 0 0 0 1px rgba(0,229,255,.35); }
    .field { display:flex; flex-direction:column; gap:8px; margin: 10px 0; }
    .label { font-size: 12px; opacity:.85; letter-spacing:.08em; text-transform:uppercase; }
    .switch {
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px; border-radius: 14px;
      border: 1px solid var(--edge);
      background: rgba(255,255,255,.03);
      user-select:none;
    }
    .switch input { width: 16px; height: 16px; }
    .status { margin-top: 10px; font-size: 13px; color: var(--muted); }
    .status.ok { color: #7CFFB2; }
    .status.err { color: #ff9b9b; }
    .tabs { display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 0; }
    .tab {
      padding: 8px 12px; border-radius: 999px; border: 1px solid var(--edge);
      background: rgba(255,255,255,.03); color: var(--text); text-decoration:none;
    }
    .tab.active { outline: 2px solid rgba(0,229,255,.25); }
    .pill {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--edge);
      background: rgba(255,255,255,.03);
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pulse {
      position: absolute; inset: -1px; border-radius: 16px; pointer-events:none;
      background: radial-gradient(circle at 15% 10%, rgba(0,229,255,.12), transparent 42%),
                  radial-gradient(circle at 85% 0%, rgba(109,40,217,.12), transparent 44%);
      opacity: .55;
      mask: linear-gradient(#000, transparent 75%);
      animation: floaty 6s ease-in-out infinite;
    }
    @keyframes floaty { 0%,100%{ transform: translateY(0);} 50%{ transform: translateY(6px);} }
  </style>
</head>
<body>
  <header class="nav" data-nav>
    <div class="container nav-inner">
      <a class="brand" href="index.html">
        <img src="assets/whaleaifulllogo.png" alt="Whale AI" class="brand-logo" />
        <span class="sr-only">Whale AI</span>
      </a>
      <nav class="nav-links">
        <a id="openWhales" href="whales.html">Whales</a>
        <a href="phantom_connect.html">Phantom Connect</a>
      </nav>
      <button class="nav-toggle" data-nav-toggle>Menu</button>
    </div>
  </header>

  <main class="page">
    <div class="container">
      <div class="section-head">
        <p class="eyebrow">Controls</p>
        <h2 style="margin:8px 0 10px;">Settings</h2>
        <p class="muted2" style="margin:0;">All values are applied immediately for your Telegram account.</p>
        <div class="tabs">
          <a id="tabRisk" class="tab" href="#risk">Risk</a>
          <a id="tabLimits" class="tab" href="#limits">Limits</a>
          <a id="tabToggles" class="tab" href="#toggles">Toggles</a>
        </div>
      </div>

      <div class="grid2" style="margin-top:18px;">
        <section id="risk" class="card panel" style="position:relative;">
          <div class="pulse" aria-hidden="true"></div>
          <h3>Risk defaults</h3>
          <p class="muted2" style="margin:0 0 8px;">
            These defaults are used when adding new whales (you can override per whale).
          </p>
          <div class="field">
            <div class="label">Default TP (%)</div>
            <input id="tp" class="input" type="number" step="0.1" min="0" placeholder="e.g. 20" />
          </div>
          <div class="field">
            <div class="label">Default SL (%)</div>
            <input id="sl" class="input" type="number" step="0.1" min="0" placeholder="e.g. 10" />
          </div>
          <div class="field">
            <div class="label">Max % per trade (of delegation cap)</div>
            <input id="maxPct" class="input" type="number" step="0.1" min="0" placeholder="e.g. 25" />
          </div>
        </section>

        <section id="limits" class="card panel">
          <h3>Trade limit</h3>
          <p class="muted2" style="margin:0 0 8px;">
            Optional: stop after N executed trades. Leave empty to run until you stop.
          </p>
          <div class="field">
            <div class="label">Stop after N trades</div>
            <input id="tradeLimit" class="input" type="number" step="1" min="1" placeholder="e.g. 25" />
          </div>
          <div class="row">
            <label class="switch"><input id="tradeLimitOff" type="checkbox" /> Disable trade limit</label>
          </div>
        </section>

        <section id="toggles" class="card panel">
          <h3>Bot toggles</h3>
          <div class="row" style="margin-top: 10px;">
            <label class="switch"><input id="notifs" type="checkbox" /> Notifications</label>
            <label class="switch"><input id="copyActive" type="checkbox" /> Copy-trading ON</label>
            <label class="switch"><input id="paperMode" type="checkbox" /> Paper mode</label>
          </div>
          <div class="field" style="margin-top: 14px;">
            <div class="label">Your max delegation cap (SOL)</div>
            <div id="capSol" class="pill">—</div>
          </div>
          <p class="muted2" style="margin:0;">
            Live mode requires: linked wallet, vault created/funded, and delegation enabled.
          </p>
        </section>

        <section class="card panel">
          <h3>Save</h3>
          <p class="muted2" style="margin:0 0 10px;">When you're done, save changes and return to Telegram.</p>
          <div class="row">
            <button id="saveBtn" class="btn btn-primary btn-lg">Save settings</button>
            <a class="btn btn-ghost btn-lg" href="https://t.me/WhaleAiTrading_bot" target="_blank" rel="noopener">Open bot</a>
          </div>
          <div id="status" class="status">Loading…</div>
        </section>
      </div>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(window.location.search);
    const tgId = qs.get("tg_id");
    const apiBase = (qs.get("api") || window.location.origin).replace(/\\/$/, "");

    document.getElementById("openWhales").href = (() => {
      const u = new URL("whales.html", window.location.href);
      if (tgId) u.searchParams.set("tg_id", tgId);
      if (qs.get("api")) u.searchParams.set("api", qs.get("api"));
      return u.toString();
    })();

    const statusEl = document.getElementById("status");
    const saveBtn = document.getElementById("saveBtn");

    function setStatus(text, kind) {
      statusEl.textContent = text;
      statusEl.className = "status" + (kind ? " " + kind : "");
    }

    function numOrNull(v) {
      if (v === null || v === undefined) return null;
      const s = String(v).trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    async function api(path, options = {}) {
      const res = await fetch(apiBase + path, {
        headers: { "Content-Type": "application/json" },
        ...options,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || "Request failed");
      return data;
    }

    function setActiveTab() {
      const hash = window.location.hash || "#risk";
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      if (hash.startsWith("#risk")) document.getElementById("tabRisk").classList.add("active");
      if (hash.startsWith("#limits")) document.getElementById("tabLimits").classList.add("active");
      if (hash.startsWith("#toggles")) document.getElementById("tabToggles").classList.add("active");
    }

    window.addEventListener("hashchange", setActiveTab);

    async function load() {
      if (!tgId) {
        setStatus("Missing tg_id. Open this from the Telegram bot.", "err");
        return;
      }

      const user = await api(`/api/user/${encodeURIComponent(tgId)}`);
      document.getElementById("tp").value = Number(user.default_tp_percent || 20).toString();
      document.getElementById("sl").value = Number(user.default_sl_percent || 10).toString();

      const frac = Number(user.max_delegation_fraction || 0.25);
      document.getElementById("maxPct").value = (frac * 100).toFixed(2).replace(/\\.00$/, "");

      document.getElementById("tradeLimit").value = user.trade_limit ? String(user.trade_limit) : "";
      document.getElementById("tradeLimitOff").checked = !user.trade_limit;

      document.getElementById("notifs").checked = !!user.notifications_enabled;
      document.getElementById("copyActive").checked = !!user.copy_active;
      document.getElementById("paperMode").checked = !!user.paper_mode;

      document.getElementById("capSol").textContent = `${Number(user.max_delegation_sol || 0).toFixed(6)} SOL`;

      setStatus("Ready.", "");

      const tab = qs.get("tab");
      if (tab === "limits") window.location.hash = "#limits";
      if (tab === "risk") window.location.hash = "#risk";
      if (tab === "toggles") window.location.hash = "#toggles";
      setActiveTab();
    }

    async function save() {
      if (!tgId) return setStatus("Missing tg_id. Open this from the Telegram bot.", "err");
      saveBtn.disabled = true;
      setStatus("Saving…", "");
      try {
        const payload = {
          notifications_enabled: document.getElementById("notifs").checked,
          copy_active: document.getElementById("copyActive").checked,
          paper_mode: document.getElementById("paperMode").checked,
          default_tp_percent: numOrNull(document.getElementById("tp").value),
          default_sl_percent: numOrNull(document.getElementById("sl").value),
          max_delegation_fraction: numOrNull(document.getElementById("maxPct").value),
        };

        if (document.getElementById("tradeLimitOff").checked) {
          payload.trade_limit_off = true;
        } else {
          payload.trade_limit = numOrNull(document.getElementById("tradeLimit").value);
          payload.trade_limit_off = false;
        }

        await api(`/api/user/${encodeURIComponent(tgId)}/settings`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        setStatus("Saved ✅", "ok");
      } catch (e) {
        setStatus("Error: " + (e.message || e), "err");
      } finally {
        saveBtn.disabled = false;
      }
    }

    document.getElementById("saveBtn").addEventListener("click", save);

    (async () => {
      try {
        await load();
      } catch (e) {
        setStatus("Error: " + (e.message || e), "err");
      }
    })();
  </script>
  <script src="config.js"></script>
  <script src="script.js" defer></script>
</body>
</html>
