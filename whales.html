<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Whale AI - Whale Manager</title>
  <meta name="theme-color" content="#070b12" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    .page { padding: 28px 0 70px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
    .grid2 { display:grid; gap:16px; grid-template-columns: 1.1fr .9fr; }
    @media (max-width: 920px){ .grid2{grid-template-columns: 1fr;} }
    .panel { padding: 18px; }
    .panel h3 { margin: 0 0 8px; }
    .muted2 { color: var(--muted); font-size: 13px; line-height: 1.5; }
    .input {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--edge);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
    }
    .input:focus { box-shadow: 0 0 0 1px rgba(0,229,255,.35); }
    .field { display:flex; flex-direction:column; gap:8px; margin: 10px 0; }
    .label { font-size: 12px; opacity:.85; letter-spacing:.08em; text-transform:uppercase; }
    .pill {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--edge);
      background: rgba(255,255,255,.03);
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .list { display:grid; gap:12px; margin-top: 14px; }
    .wcard { position: relative; }
    .wcard.highlight { outline: 2px solid rgba(0,229,255,.35); box-shadow: 0 0 0 1px rgba(0,229,255,.25), 0 0 50px rgba(0,229,255,.10); }
    .whead { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .toggles { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .switch {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid var(--edge);
      background: rgba(255,255,255,.03);
      user-select:none;
    }
    .switch input { width: 16px; height: 16px; }
    .mini-grid { display:grid; gap:10px; grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 640px){ .mini-grid{grid-template-columns: 1fr;} }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .btn-danger {
      background: rgba(255,120,120,.12);
      border-color: rgba(255,120,120,.35);
    }
    .status { margin-top: 10px; font-size: 13px; color: var(--muted); }
    .status.ok { color: #7CFFB2; }
    .status.err { color: #ff9b9b; }
    .pulse {
      position: absolute; inset: -1px; border-radius: 16px; pointer-events:none;
      background: radial-gradient(circle at 20% 10%, rgba(0,229,255,.12), transparent 40%),
                  radial-gradient(circle at 80% 0%, rgba(109,40,217,.12), transparent 44%);
      opacity: .55;
      mask: linear-gradient(#000, transparent 75%);
      animation: floaty 6s ease-in-out infinite;
    }
    @keyframes floaty { 0%,100%{ transform: translateY(0);} 50%{ transform: translateY(6px);} }
  </style>
</head>
<body>
  <header class="nav" data-nav>
    <div class="container nav-inner">
      <a class="brand" href="index.html">
        <img class="logo small" src="assets/whale.svg" alt="Whale AI" />
        <span>Whale AI</span>
      </a>
      <nav class="nav-links">
        <a id="openSettings" href="settings.html">Settings</a>
        <a href="phantom_connect.html">Phantom Connect</a>
      </nav>
      <button class="nav-toggle" data-nav-toggle>Menu</button>
    </div>
  </header>

  <main class="page">
    <div class="container">
      <div class="section-head">
        <p class="eyebrow">Custom Whales</p>
        <h2 style="margin:8px 0 10px;">Whale Manager</h2>
        <p class="muted2" style="margin:0;">
          Add whales you want to follow and control risk per whale.
          This page updates your bot settings instantly.
        </p>
      </div>

      <div class="grid2" style="margin-top:18px;">
        <section class="card panel">
          <div class="pulse" aria-hidden="true"></div>
          <h3>Add a whale</h3>
          <p class="muted2" style="margin:0 0 8px;">
            Paste a whale wallet address (base58). Defaults are based on your current cap.
          </p>

          <div class="field">
            <div class="label">Whale address</div>
            <input id="newWhale" class="input" placeholder="e.g. 4Nd1m... (base58)" autocomplete="off" />
          </div>

          <div class="mini-grid">
            <div class="field">
              <div class="label">Min size (SOL)</div>
              <input id="minSol" class="input" type="number" step="0.0001" min="0" placeholder="0.001" />
            </div>
            <div class="field">
              <div class="label">Max size (SOL)</div>
              <input id="maxSol" class="input" type="number" step="0.0001" min="0" placeholder="auto" />
            </div>
            <div class="field">
              <div class="label">Token cap (SOL)</div>
              <input id="capSol" class="input" type="number" step="0.0001" min="0" placeholder="auto" />
            </div>
          </div>

          <div class="mini-grid">
            <div class="field">
              <div class="label">TP %</div>
              <input id="tp" class="input" type="number" step="0.1" min="0" placeholder="default" />
            </div>
            <div class="field">
              <div class="label">SL %</div>
              <input id="sl" class="input" type="number" step="0.1" min="0" placeholder="default" />
            </div>
            <div class="field">
              <div class="label">Quick add</div>
              <button id="addBtn" class="btn btn-primary btn-lg" style="width:100%;">Add Whale</button>
            </div>
          </div>

          <div id="addStatus" class="status">Waiting.</div>
        </section>

        <section class="card panel">
          <h3>Your account</h3>
          <div class="muted2">Telegram ID</div>
          <div id="tg" class="pill" style="margin:6px 0 12px;">—</div>
          <div class="muted2">Max delegation</div>
          <div id="cap" class="pill" style="margin:6px 0 12px;">—</div>
          <div class="muted2">Tip</div>
          <p class="muted2" style="margin:6px 0 0;">
            You can enable/disable whales instantly. Live swaps still require a funded vault and enabled delegation.
          </p>
        </section>
      </div>

      <section class="section" style="padding:34px 0 0;">
        <div class="row" style="justify-content:space-between;">
          <div>
            <p class="eyebrow">List</p>
            <h3 style="margin:6px 0 0;">My whales</h3>
          </div>
          <div class="row">
            <button id="refreshBtn" class="btn btn-ghost">Refresh</button>
          </div>
        </div>
        <div id="listStatus" class="status">Loading…</div>
        <div id="whaleList" class="list"></div>
      </section>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(window.location.search);
    const tgId = qs.get("tg_id");
    const apiBase = (qs.get("api") || window.location.origin).replace(/\\/$/, "");
    const highlightRuleId = qs.get("rule_id");

    const elTg = document.getElementById("tg");
    const elCap = document.getElementById("cap");
    const addStatus = document.getElementById("addStatus");
    const listStatus = document.getElementById("listStatus");
    const whaleList = document.getElementById("whaleList");

    function setStatus(el, text, kind) {
      el.textContent = text;
      el.className = "status" + (kind ? " " + kind : "");
    }

    function numOrNull(v) {
      if (v === null || v === undefined) return null;
      const s = String(v).trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function shorten(addr) {
      if (!addr) return "—";
      return addr.slice(0, 6) + "…" + addr.slice(-4);
    }

    function withParams(url, extra) {
      const u = new URL(url, window.location.href);
      Object.entries(extra).forEach(([k, v]) => {
        if (v === null || v === undefined) return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }

    document.getElementById("openSettings").href = withParams("settings.html", { tg_id: tgId, api: qs.get("api") });

    async function api(path, options = {}) {
      const res = await fetch(apiBase + path, {
        headers: { "Content-Type": "application/json" },
        ...options,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || "Request failed");
      return data;
    }

    async function loadUser() {
      if (!tgId) {
        elTg.textContent = "Missing tg_id (open from bot)";
        elCap.textContent = "—";
        return;
      }
      elTg.textContent = tgId;
      const user = await api(`/api/user/${encodeURIComponent(tgId)}`);
      const maxSol = Number(user.max_delegation_sol || 0);
      elCap.textContent = `${maxSol.toFixed(6)} SOL`;
    }

    function whaleCard(rule) {
      const id = String(rule.id);
      const card = document.createElement("article");
      card.className = "card wcard";
      card.id = "rule-" + id;
      if (highlightRuleId && String(highlightRuleId) === id) {
        card.classList.add("highlight");
        setTimeout(() => card.scrollIntoView({ behavior: "smooth", block: "center" }), 180);
      }

      const head = document.createElement("div");
      head.className = "whead";
      head.innerHTML = `
        <div>
          <div class="eyebrow" style="opacity:.8">Whale</div>
          <div class="pill" title="${rule.whale_address}">${rule.whale_address}</div>
        </div>
        <div class="toggles">
          <label class="switch"><input type="checkbox" data-k="enabled" ${rule.enabled ? "checked" : ""}/> Enabled</label>
          <label class="switch"><input type="checkbox" data-k="copy_buys" ${rule.copy_buys ? "checked" : ""}/> Copy buys</label>
          <label class="switch"><input type="checkbox" data-k="copy_sells" ${rule.copy_sells ? "checked" : ""}/> Copy sells</label>
        </div>
      `;

      const grid = document.createElement("div");
      grid.className = "mini-grid";
      grid.style.marginTop = "12px";
      grid.innerHTML = `
        <div class="field"><div class="label">Min (SOL)</div><input class="input" data-k="min_trade_size_sol" type="number" step="0.0001" min="0" value="${Number(rule.min_trade_size_sol || 0).toString()}" /></div>
        <div class="field"><div class="label">Max (SOL)</div><input class="input" data-k="max_trade_size_sol" type="number" step="0.0001" min="0" value="${Number(rule.max_trade_size_sol || 0).toString()}" /></div>
        <div class="field"><div class="label">Token cap (SOL)</div><input class="input" data-k="max_token_exposure_sol" type="number" step="0.0001" min="0" value="${Number(rule.max_token_exposure_sol || 0).toString()}" /></div>
      `;

      const grid2 = document.createElement("div");
      grid2.className = "mini-grid";
      grid2.innerHTML = `
        <div class="field"><div class="label">TP %</div><input class="input" data-k="tp_percent" type="number" step="0.1" min="0" value="${Number(rule.tp_percent || 0).toString()}" /></div>
        <div class="field"><div class="label">SL %</div><input class="input" data-k="sl_percent" type="number" step="0.1" min="0" value="${Number(rule.sl_percent || 0).toString()}" /></div>
        <div class="field"><div class="label">Actions</div>
          <div class="actions">
            <button class="btn btn-primary" data-action="save">Save</button>
            <button class="btn btn-danger" data-action="delete">Remove</button>
          </div>
        </div>
      `;

      const status = document.createElement("div");
      status.className = "status";
      status.textContent = "Ready.";

      async function onSave() {
        const payload = {};
        card.querySelectorAll("[data-k]").forEach((node) => {
          const k = node.getAttribute("data-k");
          if (!k) return;
          if (node.type === "checkbox") {
            payload[k] = node.checked ? 1 : 0;
            return;
          }
          const n = numOrNull(node.value);
          if (n !== null) payload[k] = n;
        });
        try {
          setStatus(status, "Saving…", "");
          await api(`/api/user/${encodeURIComponent(tgId)}/whales/${encodeURIComponent(id)}`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Saved ✅", "ok");
        } catch (e) {
          setStatus(status, "Error: " + (e.message || e), "err");
        }
      }

      async function onDelete() {
        if (!confirm("Remove this whale?")) return;
        try {
          setStatus(status, "Removing…", "");
          await api(`/api/user/${encodeURIComponent(tgId)}/whales/${encodeURIComponent(id)}`, { method: "DELETE" });
          card.remove();
        } catch (e) {
          setStatus(status, "Error: " + (e.message || e), "err");
        }
      }

      card.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const act = btn.getAttribute("data-action");
        if (act === "save") onSave();
        if (act === "delete") onDelete();
      });

      card.appendChild(head);
      card.appendChild(grid);
      card.appendChild(grid2);
      card.appendChild(status);
      return card;
    }

    async function loadWhales() {
      if (!tgId) {
        setStatus(listStatus, "Missing tg_id. Open this from the bot.", "err");
        return;
      }
      try {
        setStatus(listStatus, "Loading whales…", "");
        whaleList.innerHTML = "";
        const rules = await api(`/api/user/${encodeURIComponent(tgId)}/whales`);
        if (!Array.isArray(rules) || rules.length === 0) {
          setStatus(listStatus, "No whales yet. Add one above.", "");
          return;
        }
        setStatus(listStatus, `${rules.length} whale(s).`, "ok");
        rules.forEach((r) => whaleList.appendChild(whaleCard(r)));
      } catch (e) {
        setStatus(listStatus, "Error: " + (e.message || e), "err");
      }
    }

    async function addWhale() {
      if (!tgId) return setStatus(addStatus, "Missing tg_id. Open this from the bot.", "err");
      const whale = (document.getElementById("newWhale").value || "").trim();
      if (!whale) return setStatus(addStatus, "Enter a whale address.", "err");
      const payload = {
        whale_address: whale,
        min_trade_size_sol: numOrNull(document.getElementById("minSol").value),
        max_trade_size_sol: numOrNull(document.getElementById("maxSol").value),
        max_token_exposure_sol: numOrNull(document.getElementById("capSol").value),
        tp_percent: numOrNull(document.getElementById("tp").value),
        sl_percent: numOrNull(document.getElementById("sl").value),
      };
      try {
        setStatus(addStatus, "Adding…", "");
        await api(`/api/user/${encodeURIComponent(tgId)}/whales`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        setStatus(addStatus, "Added ✅", "ok");
        document.getElementById("newWhale").value = "";
        await loadWhales();
      } catch (e) {
        setStatus(addStatus, "Error: " + (e.message || e), "err");
      }
    }

    document.getElementById("addBtn").addEventListener("click", addWhale);
    document.getElementById("refreshBtn").addEventListener("click", loadWhales);

    (async () => {
      if (!tgId) {
        setStatus(addStatus, "Missing tg_id. Open this from the Telegram bot.", "err");
        setStatus(listStatus, "Missing tg_id. Open this from the Telegram bot.", "err");
        return;
      }
      try {
        await loadUser();
        await loadWhales();
        setStatus(addStatus, "Ready.", "");
      } catch (e) {
        setStatus(addStatus, "Error: " + (e.message || e), "err");
        setStatus(listStatus, "Error: " + (e.message || e), "err");
      }
    })();
  </script>
  <script src="config.js"></script>
  <script src="script.js" defer></script>
</body>
</html>
